<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sistema ESP32 Â· GrÃ¡ficos VegetaciÃ³n</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      margin: 0;

      /* Imagen personalizada de Google Drive */
      background-image: url('https://drive.google.com/uc?export=view&id=1fDperXh1tNHK5zNRKdeLVcO7Dqx_u7xD'); 
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      color: #155724;
    }

    h1, h2 {
      text-align: center;
      margin: 5px 0;
      text-shadow: 1px 1px 2px #ffffffaa;
    }

    .btn {
      padding: 8px 12px;
      margin: 5px 5px 15px 5px;
      border: none;
      cursor: pointer;
      color: white;
      border-radius: 5px;
      font-size: 14px;
    }

    .excel { background: #28a745; }
    .csv { background: #17a2b8; }

    #charts {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-box {
      background: rgba(255, 255, 255, 0.85);
      padding: 10px;
      border-radius: 10px;
      width: 250px;
      height: 250px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      position: relative;
    }

    .chart-box h2 { font-size: 16px; margin-bottom: 5px; }

    canvas { width: 100% !important; height: 100% !important; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255,255,255,0.85);
      font-size: 14px;
      margin-bottom: 20px;
    }

    th, td { padding: 6px; border: 1px solid #ddd; text-align: center; }

    th { background: #28a745; color: white; }
    td { color: #155724; }

    @media (max-width: 600px) {
      #charts { flex-direction: column; align-items: center; }
      .chart-box { width: 90%; height: 250px; }
    }
  </style>
</head>
<body>

<h1>Sistema de Riego</h1>

<div>
  <a href="https://sistema-de-riego-w2uh.onrender.com/export/excel">
    <button class="btn excel">ðŸ“˜ Descargar Excel</button>
  </a>
  <a href="https://sistema-de-riego-w2uh.onrender.com/export/csv">
    <button class="btn csv">ðŸ“„ Descargar CSV</button>
  </a>
</div>

<div id="charts">
  <div class="chart-box">
    <h2>Humedad del Suelo</h2>
    <canvas id="chartHumedad"></canvas>
  </div>

  <div class="chart-box">
    <h2>Temperatura</h2>
    <canvas id="chartTemperatura"></canvas>
  </div>

  <div class="chart-box">
    <h2>Nivel de Agua</h2>
    <canvas id="chartAgua"></canvas>
  </div>

  <div class="chart-box">
    <h2>Combinado</h2>
    <canvas id="chartCombinado"></canvas>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th>Humedad (%)</th>
      <th>Temperatura (Â°C)</th>
      <th>Nivel de Agua (%)</th>
      <th>Fecha</th>
    </tr>
  </thead>
  <tbody id="tablaDatos">
    <tr><td colspan="4">Cargando...</td></tr>
  </tbody>
</table>

<script>
const API = "https://sistema-de-riego-w2uh.onrender.com/datos";

// Plugin para mostrar porcentaje centrado
const centerTextPlugin = {
  id: 'centerText',
  afterDraw(chart) {
    const {ctx, chartArea, data} = chart;
    if(!data.datasets[0].data.length) return;
    const value = data.datasets[0].data[0];
    ctx.save();
    ctx.font = 'bold 18px Arial';
    ctx.fillStyle = '#000';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const centerX = (chartArea.left + chartArea.right) / 2;
    const centerY = (chartArea.top + chartArea.bottom) / 2;
    ctx.fillText(value + '%', centerX, centerY);
    ctx.restore();
  }
};

const createGauge = (ctx, color) => new Chart(ctx, {
  type: 'doughnut',
  data: { labels: ["Valor", ""], datasets: [{ data: [0, 100], backgroundColor: [color, "#eee"], borderWidth: 1 }] },
  options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { enabled: false }, centerText: true } },
  plugins: [centerTextPlugin]
});

const chartHumedad = createGauge(document.getElementById("chartHumedad").getContext("2d"), "saddlebrown");
const chartTemperatura = createGauge(document.getElementById("chartTemperatura").getContext("2d"), "gold");
const chartAgua = createGauge(document.getElementById("chartAgua").getContext("2d"), "dodgerblue");

const chartCombinado = new Chart(document.getElementById("chartCombinado").getContext("2d"), {
  type: 'doughnut',
  data: { labels: ["Humedad", "Temp", "Agua", ""], datasets: [{ data: [0,0,0,100], backgroundColor: ["saddlebrown", "gold", "dodgerblue", "#eee"], borderWidth: 1 }] },
  options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' }, tooltip: { enabled: true } } }
});

async function cargarDatos() {
  try {
    const res = await fetch(API);
    const datos = await res.json();
    const ultimos = datos.slice(-1)[0];

    const tabla = document.getElementById("tablaDatos");
    tabla.innerHTML = "";
    datos.slice(-10).forEach(d => {
      tabla.innerHTML += `
        <tr>
          <td>${d.humedad ?? "-"}</td>
          <td>${d.temperatura ?? "-"}</td>
          <td>${d.nivelAgua ?? "-"}</td>
          <td>${new Date(d.fecha).toLocaleString()}</td>
        </tr>
      `;
    });

    if (ultimos) {
      chartHumedad.data.datasets[0].data = [ultimos.humedad ?? 0, 100 - (ultimos.humedad ?? 0)];
      chartHumedad.update();

      chartTemperatura.data.datasets[0].data = [ultimos.temperatura ?? 0, 100 - (ultimos.temperatura ?? 0)];
      chartTemperatura.update();

      chartAgua.data.datasets[0].data = [ultimos.nivelAgua ?? 0, 100 - (ultimos.nivelAgua ?? 0)];
      chartAgua.update();

      chartCombinado.data.datasets[0].data = [
        ultimos.humedad ?? 0,
        ultimos.temperatura ?? 0,
        ultimos.nivelAgua ?? 0,
        Math.max(0, 100 - ((ultimos.humedad ?? 0) + (ultimos.temperatura ?? 0) + (ultimos.nivelAgua ?? 0)))
      ];
      chartCombinado.update();
    }

  } catch (err) {
    console.error(err);
  }
}

cargarDatos();
setInterval(cargarDatos, 5000);
</script>

</body>
</html>
